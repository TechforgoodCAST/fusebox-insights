<%# TODO: refactor %>

<script type="text/javascript">
$(function(){

  $('a[data-status]').on('click', function(){
    var status = $(this).data('status');
    $('#statuses li').removeClass('active');
    $(this).parent('li').addClass('active');

    if(status == 'all'){
      $('#roadmap .row ').show();
    }else if(status == 'default'){
      $('#roadmap .row ').hide();
      $('#roadmap .row.planned').show();
      $('#roadmap .row.in-progress').show();
    }else{
      $('#roadmap .row ').hide();
      $('#roadmap .row.'+status).show();
    }
    $('#roadmap .row.start').show();

  });

});



</script>

<style type="text/css">
  ul#statuses li a{
    cursor: pointer;
  }

  ul#statuses{
    list-style: none;
    padding: 0;
    margin: 0;
  }

  ul#statuses li{
    padding-left: 15px;
    margin-left: -15px;
  }
  ul#statuses li.active{
    padding-left: 13px;
    border-left: 2px solid black;
  }
</style>

<!--
<p><%= @project.description %></p>
<%= link_to 'Edit', edit_project_path(@project), class: "btn btn-primary" %>
<%= link_to 'Destroy', project_path(@project),
              method: :delete,
              data: { confirm: 'Are you sure?' },
              class: "btn btn-primary"%>

<h2>Roadmap</h2>-->

<%= render partial: 'subnav' %>

<div class="row">
  <div class="col-4">
    <h3 class="mt-3">Status</h3>
    <ul id="statuses" class="mb-3">
      <li class="active"><a data-status="default">Default</a></li>
      <li><a data-status="all">All</a></li>
      <li><a data-status="complete">Complete</a></li>
      <li><a data-status="in-progress">In progress</a></li>
      <li><a data-status="planned">Planned</a></li>
    </ul>
  </div>


  <style>
    #roadmap{
      border-left: 4px solid #ccc;
    }

    .milestone::before{
      content:"";
      height: 20px;
      width: 20px;
      border: 2px solid #999;
      transform: rotate(45deg);
      margin-right: 10px;
      margin-left: 13px;
      background: #fff;
    }

    .start::before{
      content:"";
      height: 20px;
      width: 20px;
      border: 2px solid #999;
      border-radius: 100%;
      margin-right: 10px;
      margin-left: 13px;
      background: #fff;
    }

    #roadmap .row{
      margin-left: -40px;
    }

    .row.divider{
      border-top: 3px solid purple;
      margin-bottom: 10px;
    }

    .divider .status-box{
      text-align: center;
      padding: 5px 10px;
      background: purple;
      color: white;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .card{
      border: 3px solid #999;
      border-radius: 0;
    }

  </style>
  <div id="roadmap" class="col-8">
    <%
    merged = [];

    #Get iterations
    @project.iterations.each do |iteration|
      merged << {
        :type       => 'iteration',
        :start_date => iteration.start_date,
        :end_date   => iteration.end_date,
        :data       => iteration
      }
    end

    #Get milestones
    @project.milestones.each do |milestone|
      merged << {
        :type       => 'milestone',
        :start_date => milestone.deadline || Date.tomorrow,
        :end_date   => milestone.completed_on || Date.tomorrow,
        :data       => milestone
      }
    end

    #merged << {
    #    :type => 'divider',
    #    :date => Date.today
    #}

    #Sort the merged array reverse chronologically
    items = merged.sort_by { |hsh| hsh[:start_date] }
    old_status = '';
    items.each_with_index do |item|

      if item[:end_date] < Date.today
        status = 'Completed'
      end

      if item[:start_date] < Date.today && item[:end_date] > Date.today
        status = 'In progress'
      end

      if item[:start_date] > Date.today
        status = 'Planned'
      end

      if status != old_status
      %>
        <div class='row divider  <%= status&.parameterize %>'>
          <div class='status-box'>
            <%= status %>
          </div>
        </div>
      <%
        old_status = status
      end




      if item[:type] == 'iteration'
        iteration = item[:data]
    %>
        <div class='row iteration <%= status.parameterize %>'>
          <div class='card mb-4'>
            <div class="card-body">
              <h4 class="pt-1 mb-1"><%= link_to iteration.title, [@project, iteration] %> </h4>
              <%= render "layouts/iteration_progress", project: @project, iteration: iteration %>
            </div>
          </div>
        </div>
      <%
      elsif item[:type] == 'milestone'
        milestone = item[:data]
      %>
        <div class='row milestone <%= milestone.status.parameterize %>'>
          <p><%= milestone.status.parameterize %></p>
          <p><strong><%= link_to milestone.title, project_milestone_path(@project, milestone) %>:</strong> <%= milestone.description%></p>
          <p>By <%= milestone.deadline.strftime("%b %Y") %></p>
        </div>
      <% end %>
    <% end %>
    <div class='row start'>
      <p>Add an <%= link_to 'iteration', new_project_iteration_path(@project)%> or <%= link_to 'milestone', new_project_milestone_path(@project)%></p>
    </div>
  </div>
</div>